<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>여행 준비물 - 전체 목록</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#f6f8fa; margin:0; }
  .wrap{ max-width:1100px; margin:24px auto; background:#fff; padding:18px; border-radius:14px; box-shadow:0 6px 24px rgba(0,0,0,0.06);}
  .top{ display:flex; gap:12px; align-items:center; }
  h1{ font-size:20px; margin:0; }
  .right{ margin-left:auto; }
  a.link{ text-decoration:none; color:#0d6efd; font-weight:600; }
  table{ width:100%; border-collapse:collapse; margin-top:14px; }
  th, td{ border-bottom:1px solid #eee; padding:10px; text-align:left; }
  th{ background:#fafafa; }
  input[type="text"]{ border:1px solid #ddd; border-radius:8px; padding:8px; }
  .btn{ border:0; border-radius:8px; padding:8px 11px; cursor:pointer; font-weight:600; }
  .btn-primary{ background:#0d6efd; color:#fff; }
  .btn-gray{ background:#e9ecef; }
  .btn-danger{ background:#dc3545; color:#fff; }
  .row{ display:flex; gap:10px; align-items:center; margin:12px 0; flex-wrap:wrap; }
  .muted{ color:#666; font-size:13px; }
  td.title-cell{ color:#0d6efd; font-weight:600; cursor:pointer; }
  td.title-cell:hover{ text-decoration:underline; }
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <h1>여행 준비물 - 전체 목록</h1>
    <div class="right">
      <a class="link" href="packing_new.html">신규 입력</a>
    </div>
  </div>

  <div class="row">
    <input type="text" id="newTitle" placeholder="새 여행제목 (빈 목록 생성)" />
    <button class="btn btn-primary" id="createEmpty">빈 목록 생성</button>
    <span class="muted">※ 제목만 미리 만들고, 관리 페이지에서 항목을 추가할 수 있습니다.</span>
  </div>

  <table id="tbl">
    <thead>
      <tr>
        <th style="width:34px;">#</th>
        <th>여행제목</th>
        <th style="width:180px;">체크완료</th>
        <th style="width:220px;">작업</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
  const supabase = window.supabase.createClient(
    'https://xxmtxuhcdzidhrefrvwf.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh4bXR4dWhjZHppZGhyZWZydndmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQwODAyNTQsImV4cCI6MjA1OTY1NjI1NH0.TaCCDlJvKrif_pZY038Qkglip8h-Qqjp2w2GlKwvoVg'
  );

  const tbody = document.querySelector('#tbl tbody');
  function escapeHtml(s=''){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  async function loadList(){
    const { data, error } = await supabase
      .from('packing_items')
      .select('trip_title, checked, created_at');

    if(error){ alert('불러오기 실패: '+error.message); return; }

    const map = new Map();
    for(const r of (data||[])){
      if(!map.has(r.trip_title)) map.set(r.trip_title, { total:0, checked:0, last:0 });
      const agg = map.get(r.trip_title);
      agg.total += 1;
      if(r.checked) agg.checked += 1;
      const t = r.created_at ? new Date(r.created_at).getTime() : 0;
      if(t > agg.last) agg.last = t;
    }

    const titles = [...map.keys()].sort((a,b)=> (map.get(b).last - map.get(a).last));

    tbody.innerHTML='';
    let idx=1;
    for(const t of titles){
      const agg = map.get(t);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx++}</td>
        <td class="title-cell" onclick="location.href='packing_manage.html?title=${encodeURIComponent(t)}'">${escapeHtml(t)}</td>
        <td>${agg.checked} / ${agg.total}</td>
        <td>
          <button class="btn btn-gray" onclick="cloneTitle('${encodeURIComponent(t)}')">복제</button>
          <button class="btn btn-danger" onclick="deleteTitle('${encodeURIComponent(t)}')">삭제</button>
        </td>
      `;
      tbody.appendChild(tr);
    }

    if(!titles.length){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="4" style="text-align:center; color:#666;">아직 데이터가 없습니다. 우측 상단 '신규 입력'을 눌러 시작하세요.</td>`;
      tbody.appendChild(tr);
    }
  }

  async function cloneTitle(encTitle){
    const title = decodeURIComponent(encTitle);
    const newTitle = prompt('새 여행제목으로 복제합니다. 입력하세요:', title+' 복제본');
    if(!newTitle || newTitle.trim()===title) return;

    const { data, error } = await supabase
      .from('packing_items')
      .select('item_name, quantity, note')
      .eq('trip_title', title);
    if(error){ alert('원본 로드 실패: '+error.message); return; }
    if(!data || !data.length){ alert('복제할 항목이 없습니다.'); return; }

    const toInsert = data.map(r=>({
      trip_title: newTitle.trim(),
      item_name: r.item_name,
      quantity: r.quantity,
      checked: false,
      note: r.note
    }));
    const { error: insErr } = await supabase.from('packing_items').insert(toInsert);
    if(insErr){ alert('복제 실패: '+insErr.message); return; }
    alert('복제 완료!');
    loadList();
  }

  async function deleteTitle(encTitle){
    const title = decodeURIComponent(encTitle);
    if(!confirm(`'${title}' 전체를 삭제할까요? (되돌릴 수 없습니다)`)) return;
    const { error } = await supabase.from('packing_items').delete().eq('trip_title', title);
    if(error){ alert('삭제 실패: '+error.message); return; }
    alert('삭제되었습니다.');
    loadList();
  }

  document.getElementById('createEmpty').onclick = async ()=>{
    const newTitle = document.getElementById('newTitle').value.trim();
    if(!newTitle){ alert('제목을 입력하세요.'); return; }
    const { error } = await supabase.from('packing_items')
      .insert([{ trip_title: newTitle, item_name: '(새 항목)', quantity: 1, checked: false, note: null }]);
    if(error){ alert('생성 실패: '+error.message); return; }
    location.href = 'packing_manage.html?title='+encodeURIComponent(newTitle);
  };

  loadList();
</script>
</body>
</html>
