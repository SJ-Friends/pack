<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>여행 준비물 - 관리</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  body{
    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    background:#f6f8fa; margin:0;
    padding-bottom: calc(78px + env(safe-area-inset-bottom, 0px));
  }
  .wrap{ max-width:1100px; margin:24px auto; background:#fff; padding:18px; border-radius:14px; box-shadow:0 6px 24px rgba(0,0,0,0.06);}
  .top{ display:flex; gap:12px; align-items:center; margin-bottom:12px; }
  h1{ font-size:20px; margin:0; }
  .title-badge{ padding:6px 10px; background:#eef4ff; border-radius:999px; font-weight:700; color:#0d6efd; }
  .right{ margin-left:auto; }
  a.link{ text-decoration:none; color:#0d6efd; font-weight:600; }

  table.table-fixed{ width:100%; border-collapse:collapse; table-layout:fixed; }
  th, td{ border-bottom:1px solid #eee; padding:10px; text-align:left; vertical-align:middle; }
  thead th{ background:#fafafa; }

  .table-fixed th, .table-fixed td{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  .col-check{ width:40px; text-align:center; }
  .col-item { width:55%; }
  .col-qty  { width:50px; text-align:center; }
  .col-note { width:25%; }
  .col-del  { width:70px; text-align:center; }

  input[type="text"], input[type="number"]{
    border:1px solid #ddd; border-radius:8px; padding:8px; width:100%;
  }
  .chk{ width:20px; height:20px; accent-color:#0d6efd; }

  .btn{ border:0; border-radius:8px; padding:9px 12px; cursor:pointer; font-weight:600; }
  .btn-primary{ background:#0d6efd; color:#fff; }
  .btn-gray{ background:#e9ecef; }
  .btn-danger{ background:#dc3545; color:#fff; }

  .row{ display:flex; gap:10px; align-items:center; margin:12px 0; flex-wrap:wrap; }
  .pill{ padding:6px 10px; border-radius:999px; background:#f1f3f5; }
  .muted{ color:#666; font-size:13px; }
  .count{ font-weight:700; }

  .sticky-bar{
    position:fixed; left:0; right:0; bottom:0;
    background:#ffffff; border-top:1px solid #eee;
    padding:12px 16px calc(12px + env(safe-area-inset-bottom, 0px)) 16px;
    box-shadow:0 -8px 24px rgba(0,0,0,0.06);
    display:flex; gap:10px; align-items:center; justify-content:flex-end;
    z-index:999;
  }
  .sticky-left{
    margin-right:auto; display:flex; gap:8px; align-items:center; flex-wrap:wrap;
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <h1>여행 준비물 - 관리</h1>
    <div class="title-badge" id="titleBadge"></div>
    <div class="right"><a class="link" href="packing_list.html">전체 목록</a></div>
  </div>

  <table id="tbl" class="table-fixed">
    <thead>
      <tr>
        <th class="col-check">체크</th>
        <th class="col-item">준비물</th>
        <th class="col-qty">수량</th>
        <th class="col-note">비고</th>
        <th class="col-del">삭제</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

</div>

<div class="sticky-bar">
  <button class="btn btn-primary" id="saveChangesSticky">변경사항 저장</button>
</div>

<script>
  // ===== Supabase 클라이언트 전역 변수로 생성 =====
  window.sb = window.supabase.createClient(
    'https://xxmtxuhcdzidhrefrvwf.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh4bXR4dWhjZHppZGhyZWZydndmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQwODAyNTQsImV4cCI6MjA1OTY1NjI1NH0.TaCCDlJvKrif_pZY038Qkglip8h-Qqjp2w2GlKwvoVg'
  );

  const params = new URLSearchParams(location.search);
  const tripTitle = params.get('title') || '';
  document.getElementById('titleBadge').textContent = tripTitle || '(제목 없음)';

  const tbody = document.querySelector('#tbl tbody');

  async function loadItems(){
    if(!tripTitle) return;

    const { data, error } = await sb
      .from('packing_items')
      .select('*')
      .eq('trip_title', tripTitle);

    if(error){
      alert('불러오기 실패: ' + error.message);
      return;
    }

    tbody.innerHTML = '';

    for(const row of data){
      const tr = document.createElement('tr');
      tr.dataset.id = row.id;

      tr.innerHTML = `
        <td class="col-check">
          <input type="checkbox" class="chk" ${row.checked ? 'checked' : ''}>
        </td>
        <td class="col-item">
          <input type="text" class="item" value="${row.item_name || ''}">
        </td>
        <td class="col-qty">
          <input type="number" class="qty" value="${row.quantity || 1}">
        </td>
        <td class="col-note">
          <input type="text" class="note" value="${row.note || ''}">
        </td>
        <td class="col-del">
          <button class="btn btn-danger del">삭제</button>
        </td>
      `;

      tbody.appendChild(tr);
    }
  }

  async function saveChanges(){
    const rows = tbody.querySelectorAll('tr');

    for(const tr of rows){
      const id = tr.dataset.id;

      const item_name = tr.querySelector('.item').value;
      const quantity = tr.querySelector('.qty').value;
      const note = tr.querySelector('.note').value;

      const { error } = await sb
        .from('packing_items')
        .update({
          item_name,
          quantity,
          note
        })
        .eq('id', id);

      if(error){
        alert('저장 실패: ' + error.message);
        return;
      }
    }

    alert('저장 완료');
  }

  document.getElementById('saveChangesSticky').onclick = saveChanges;

  loadItems();
</script>
</body>
</html>
